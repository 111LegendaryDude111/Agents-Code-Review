name: AI Review Check

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: ai-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  ai-review:
    if: ${{ !github.event.pull_request.draft }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      GITHUB_TOKEN: ${{ github.token }}
      GITHUB_REPOSITORY: ${{ github.repository }}
      PR_NUMBER: ${{ github.event.pull_request.number }}
      LLM_PROVIDER: huggingface
      LLM_MODEL: Qwen/Qwen2.5-Coder-32B-Instruct
      LLM_BASE_URL: https://router.huggingface.co/v1
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
      PROJECT_CONTEXT_PATH: project-context.json
      AI_REVIEW_MAX_ISSUE_COMMENTS: "3"
      AI_REVIEW_DETAILED_SEVERITIES: "BLOCKER,IMPORTANT"
      AI_REVIEW_MAX_SUMMARY_ITEMS: "20"
      AI_REVIEW_MAX_MESSAGE_CHARS: "220"
      AI_REVIEW_MAX_SUGGESTION_CHARS: "160"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Validate required secrets
        run: |
          if [ -z "${HF_TOKEN}" ]; then
            echo "Missing secret: HF_TOKEN"
            exit 1
          fi

      - name: Install dependencies
        run: make setup

      - name: Generate project context
        run: make build-context

      - name: Run AI review
        run: make run

      - name: Publish AI review comments to PR
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const run = require("./.github/scripts/publish-ai-review.js");
            await run({ github, context, core });

      - name: Upload review artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ai-review-result
          path: |
            result.json
            project-context.json
          if-no-files-found: ignore
